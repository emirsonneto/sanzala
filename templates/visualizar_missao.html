{%extends "base.html" %}
{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='visualizar.css') }}">
{% endblock %}
{% block content %}
<div class="container">
<a href="{{ url_for('public.home') }}" class="back-icon">
    <i class="bi bi-arrow-left"></i>
</a>
  <div class="missao-header">
    <h2><i class="bi bi-terminal"></i> {{desafio.titulo}}</h2>
    <p class="lead">{{desafio.descricao}}</p>
  </div>

  <div class="meta-info">
    <span class="categoria"><i class="bi bi-grid"></i> Categoria: {{desafio.categoria}}</span>
    <span class="nivel"><i class="bi bi-bar-chart"></i> N√≠vel: {{desafio.nivel}}</span>
    <span class="estado ativa"><i class="bi bi-activity"></i> Estado: {{desafio.estado}}</span>
  </div>

  <img src="https://cdn-icons-png.flaticon.com/512/3412/3412603.png" alt="Imagem da Miss√£o" class="missao-img">
  
  <div class="painel-missao">
    <h5>Instru√ß√µes:</h5>
    <p>Pontua√ß√£o: <strong>{{ current_user.pontuacao }}</strong> üèÜ</p>
    <ul>
      <li>L√™ com aten√ß√£o cada parte da miss√£o ‚Äî qualquer detalhe pode ser √∫til..</li>
      <li>tem muita pistas ou descobertas nos flash de historias ...</li>
      <li>Todas as flags seguem o formato padr√£o: 3c0{...}</li>
      <li>Ao encontrar uma flag, registra-a no sistema para validar o progresso.</li>
      <li>Encontra todas as flags para completar a missao üèÅ.</li>
      </ul>
    <div class="alert alert-warning">
      Foram carregadas {{ form.flags|length }} flags para este desafio. <a href="{{ url_for('desafio_bp.missao', id=desafio.id, slug=desafio.slug) }}" target ="_blank">acessar missao</a>
    </div>
    <form id="form-validar-flags">
      {{ form.hidden_tag() }}

      {% for flag_form in form.flags %}
        <div class="mb-3">
          <label class="form-label">Flag {{ loop.index }}</label>
          <div class="input-group">
            {{ flag_form.valor(
                class="form-control bg-black text-light border-success",
                id="flag-valor-" ~ loop.index0,
                placeholder="Digite a flag..."
            ) }}
            <button 
              type="button" 
              class="btn btn-submit"
              onclick="validarFlag({{ desafio.id }}, {{ loop.index0 }})"
              id="botao-flag-{{ loop.index0 }}"
            >
              <i class="bi bi-send"></i>
            </button>
          </div>
          <div id="resultado-flag-{{ loop.index0 }}" class="mt-2"></div>
        </div>
      {% endfor %}
    </form>
    <div id="resultado-validacao" class="mt-3"></div>
  </div>
</div>

<footer style="background: #0d0d0d; color: #e0fdf4; padding-top: 2rem;">
  <div class="container text-center mb-4">
    <!-- LOGO SVG CENTRALIZADA -->
    <svg width="100" height="100" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
      <circle cx="70" cy="70" r="66" fill="none" stroke="#00FFAE" stroke-width="3.5"/>
      <text x="70" y="90" text-anchor="middle" font-size="110" font-family="Segoe UI Black, Arial Black, sans-serif" fill="#00FFAE" dominant-baseline="middle">S</text>
      <defs><path id="curva-footer" d="M 35,32 A 47,47 0 0,1 105,32"/></defs>
      <text font-size="10" font-family="Arial Black, sans-serif" fill="#00FFAE" letter-spacing="2">
        <textPath href="#curva-footer" startOffset="50%" text-anchor="middle">SANZALA</textPath>
      </text>
    </svg>
    <p class="mt-2 small text-muted">Guardioes de Memorias</p>
  </div>

  <!-- COLUNAS -->
  <div class="container">
    <div class="row text-center text-md-start">
      <div class="col-md-4 footer-section mb-4">
        <h6><i class="bi bi-link-45deg"></i> Links √öteis</h6>
        <ul class="list-unstyled">
          <li><a href="#" class="text-decoration-none text-light">In√≠cio</a></li>
          <li><a href="#" class="text-decoration-none text-light">Miss√µes</a></li>
          <li><a href="#" class="text-decoration-none text-light">Blog</a></li>
        </ul>
      </div>
      <div class="col-md-4 footer-section mb-4">
        <h6><i class="bi bi-info-circle"></i> Sobre a Sanzala</h6>
        <ul class="list-unstyled">
          <li><a href="#" class="text-decoration-none text-light">Hist√≥ria</a></li>
          <li><a href="#" class="text-decoration-none text-light">Objetivos</a></li>
          <li><a href="#" class="text-decoration-none text-light">Equipe</a></li>
        </ul>
      </div>
      <div class="col-md-4 footer-section mb-4">
        <h6><i class="bi bi-share-fill"></i> Social</h6>
        <ul class="list-unstyled">
          <li><a href="#" class="text-decoration-none text-light"><i class="bi bi-discord"></i> Discord</a></li>
          <li><a href="#" class="text-decoration-none text-light"><i class="bi bi-twitter"></i> Twitter</a></li>
          <li><a href="#" class="text-decoration-none text-light"><i class="bi bi-instagram"></i> Instagram</a></li>
        </ul>
      </div>
    </div>

    <!-- RODAP√â INFERIOR -->
    <div class="footer-bottom text-center py-3 border-top border-secondary">
      ¬© 2025 A Sanzala. Todos os direitos reservados. |
      <a href="{{ url_for('public.termos') }}" class="text-decoration-none text-secondary">Termos & Condi√ß√µes</a>
    </div>
  </div>
</footer>
<script>
function validarFlag(desafioId, index) {
  const input = document.getElementById(`flag-valor-${index}`);
  const botao = document.getElementById(`botao-flag-${index}`);
  const resultadoDiv = document.getElementById(`resultado-flag-${index}`);
  const valor = input.value.trim();

  fetch(`/desafio/${desafioId}/validar_flag`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token() }}"
    },
    body: JSON.stringify({ valor: valor })
  })
  .then(response => response.json())
  .then(data => {
    // Cria elemento de mensagem
    const alerta = document.createElement("div");
    alerta.className = `alert ${data.success ? 'alert-success' : 'alert-danger'} fade-out p-2 m-0`;
    alerta.innerText = data.mensagem;

    // Limpa e adiciona mensagem
    resultadoDiv.innerHTML = '';
    resultadoDiv.appendChild(alerta);

    // ‚úÖ Scroll at√© o topo suavemente
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // ‚úÖ Inicia desaparecimento
    setTimeout(() => {
      alerta.classList.add("hide"); // ativa fade
    }, 2000); // espera 2 segundos antes de come√ßar o fade

    // ‚úÖ Remove da tela depois do fade
    setTimeout(() => {
      alerta.remove();
    }, 4000); // espera total de 4s

    // ‚úÖ Desativa campo e bot√£o se correto
    if (data.success) {
      input.disabled = true;
      input.classList.add("is-valid");
      botao.disabled = true;
    } else {
      input.classList.add("is-invalid");
      setTimeout(() => input.classList.remove("is-invalid"), 2000);
    }
  })
  .catch(error => {
    resultadoDiv.innerHTML = `<div class="alert alert-danger p-2">Erro ao validar a flag.</div>`;
    console.error("Erro:", error);
  });
}
</script>

{% endblock %}
